import { Link, navigate } from 'gatsby'
import React, { useState, useEffect } from 'react'
import Loader from './loader'
import Ticker from './ticker'
import useWindowSize from '../utils/useWindowSize'

const apiKey = process.env.GATSBY_WEATHER_KEY
const cityName = 'new york'

const Header = ({ location, handleCategoryFilter }) => {
  const [isOpen, setIsOpen] = useState(false)
  const [loading, setLoading] = useState(true)
  const [weatherData, setWeatherData] = useState(null)
  const [nyTime, setNyTime] = useState(
    new Date().toLocaleTimeString('en-US', {
      timeZone: 'America/New_York',
      hour: 'numeric',
      minute: '2-digit',
      second: '2-digit',
    })
  )

  const { width } = useWindowSize()

  const toggleMenu = () => {
    setIsOpen(!isOpen)
  }

  const convertToFahrenheit = (temp) => {
    return Math.round(temp * (9 / 5) + 32)
  }

  useEffect(() => {
    const interval = setInterval(() => {
      setNyTime(
        new Date().toLocaleTimeString('en-US', {
          timeZone: 'America/New_York',
          hour: 'numeric',
          minute: '2-digit',
          second: '2-digit',
        })
      )
    }, 1000)
    return () => clearInterval(interval)
  }, [nyTime])

  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch(
        `https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=${apiKey}&units=metric`
      )
      const data = await response.json()
      setWeatherData(data)
      setLoading(false)
    }
    fetchData()
  }, [])

  return (
    <div className='header-container'>
      <div className='header-main'>
        <div className='header-logo-container'>
          <Link
            to='/'
            className='header-logo-link'
            onClick={() => setIsOpen(false)}
          >
            <svg
              xmlns='http://www.w3.org/2000/svg'
              viewBox='0 0 543.501 82.377'
            >
              <path
                id='Path_1'
                data-name='Path 1'
                d='M-26.3-82.9h1.773c2.8,0,5.525,4.1,5.525,17.163,0,9.5-1.031,16.623-5.237,16.623-1.856,0-2.062-.54-2.062-7.556Zm0-29.9c0-1.835.289-3.238,1.567-3.238.619,0,1.856.108,2.68,2.051,1.278,2.914,1.649,7.772,1.649,12.845,0,12.089-2.227,14.464-4.288,14.464H-26.3ZM-37.471-45.331H-25.8a23.772,23.772,0,0,0,4.66-.324C-15.493-46.95-11-51.916-11-66.6c0-6.692-2.144-12.845-4.165-15.22a10.186,10.186,0,0,0-4.33-3.346v-.216a7.175,7.175,0,0,0,2.722-2.267c2.392-2.914,4.041-7.88,4.041-15,0-7.017-1.031-9.931-2.186-12.522-1.938-4.425-5.443-4.641-9.319-4.641H-37.471v2.591c2.557.216,3.5.756,3.5,9.5v50.3c0,8.744-.948,9.283-3.5,9.5Zm26.678,0H3.887v-2.591c-2.557-.216-3.5-.756-3.5-9.5v-50.3c0-8.743.948-9.283,3.5-9.5v-2.591h-14.68v2.591c2.557.216,3.5.756,3.5,9.5v50.3c0,8.744-.948,9.283-3.5,9.5Zm14.185,0H28.462l1.608-22.56-.99-.648a59.693,59.693,0,0,1-2.1,10.255c-2.763,8.527-4.866,8.635-9.113,8.635-3.134,0-3.3-1.4-3.3-9.283v-23.64c4.536,0,6.061,5.505,6.6,16.515h.989v-36.808h-.989c-.536,11.01-2.062,16.515-6.6,16.515v-23.532c0-5.4.536-5.613,2.556-5.613h2.639c5.03,0,6.969,5.721,7.422,16.731h.989v-21.049H3.392v2.591c2.556.216,3.5.756,3.5,9.5v50.3c0,8.744-.949,9.283-3.5,9.5Zm26.678,0H40.214v-2.591c-2.722.108-4.536-1.187-4.536-10.255V-104.16L56.625-45.148h.99v-61.818c0-6.585.866-9.931,3.134-10.255v-2.591h-9.4v2.591c2.515,0,4.288,1.187,4.288,10.255v31.627L40.42-119.812H30.07v2.591c1.319.108,1.732.108,3.628,6.8v51.812c0,6.8-.907,10.363-3.628,10.686Zm29.606,0H69.82v-2.591c-2.722.108-4.536-1.187-4.536-10.255V-104.16L86.232-45.148h.99v-61.818c0-6.585.866-9.931,3.134-10.255v-2.591h-9.4v2.591c2.515,0,4.288,1.187,4.288,10.255v31.627L70.027-119.812H59.677v2.591c1.32.108,1.732.108,3.629,6.8v51.812c0,6.8-.907,10.363-3.629,10.686Zm29.606,0h14.68v-2.591c-2.557-.216-3.5-.756-3.5-9.5v-50.3c0-8.743.948-9.283,3.5-9.5v-2.591H89.283v2.591c2.557.216,3.5.756,3.5,9.5v50.3c0,8.744-.948,9.283-3.5,9.5Zm13.813,0h9.732v-2.591c-1.732,0-3.711-.648-3.711-6.369A95.7,95.7,0,0,1,110.643-66.7h10.35l.536,3.13c.371,2.051,1.649,8.851,1.649,11.334,0,1.943-.495,3.346-1.031,3.778a3.511,3.511,0,0,1-2.268.54v2.591h15.669v-2.591c-1.526,0-2.639-2.159-3.422-5.505s-1.485-7.556-2.515-13.169l-10.226-53.185h-1.4l-10.35,59.23c-1.278,7.448-1.567,11.658-4.536,12.629Zm8.288-25.69,4.206-25.151,4.495,25.151Zm23.957,25.69h23.751l1.526-24.4-.99-.864c-1.278,12.09-3.958,20.941-8.907,20.941-3.5,0-4.206-.864-4.206-7.34v-50.733c0-8.743.948-9.283,3.5-9.5v-2.591h-14.68v2.591c2.557.216,3.505.756,3.505,9.5v50.3c0,8.744-.948,9.283-3.505,9.5Zm32.039,0h17.484l2.144-23.747h-1.031c-.907,6.8-1.567,7.988-4.206,7.988H173.9c-.206,0-.289-.324-.289-.648a3.345,3.345,0,0,1,.371-1.3l5.979-14.249c2.845-6.8,5.4-13.816,5.4-24.611,0-11.55-3.3-19.322-7.628-19.322-5.4,0-8.124,9.283-9.979,21.373l.949,1.511c1.113-5.721,2.556-10.039,5.2-10.039,3.175,0,5.03,5.613,5.03,13.709,0,9.283-3.3,20.617-5.443,27.417l-6.1,19.538Zm25.4-52.892c0-12.953.082-19.862,2.556-19.862s2.557,6.908,2.557,19.862v31.3c0,12.953-.082,19.862-2.557,19.862s-2.556-6.908-2.556-19.862Zm-6.845,15.652c0,15.976,2.68,38.644,9.4,38.644s9.4-22.668,9.4-38.644-2.68-38.643-9.4-38.643-9.4,22.668-9.4,38.643m17.731,37.24h17.483L223.3-69.078h-1.031c-.907,6.8-1.567,7.988-4.206,7.988h-7.876c-.206,0-.288-.324-.288-.648a3.345,3.345,0,0,1,.371-1.3l5.979-14.249c2.845-6.8,5.4-13.816,5.4-24.611,0-11.55-3.3-19.322-7.628-19.322-5.4,0-8.123,9.283-9.979,21.373l.949,1.511c1.113-5.721,2.556-10.039,5.2-10.039,3.175,0,5.031,5.613,5.031,13.709,0,9.283-3.3,20.617-5.443,27.417l-6.1,19.538Zm23.627-37.456c2.35.216,5.072,3.562,6.927,9.823,1.278,4.318,1.567,7.124,1.567,12.629,0,6.585-1.814,10.686-3.546,10.686a1.912,1.912,0,0,1-1.814-1.187c-2.433-4.426-3.34-9.607-5.732-9.607-1.485,0-2.515,2.59-2.515,6.477,0,6.908,3.3,10.039,5.484,10.039,3.258,0,6.556-2.375,8.618-6.477,2.391-4.75,4.783-11.01,4.783-21.589,0-10.254-1.856-17.379-5.608-20.185v-.863c2.309-2.375,3.794-7.664,3.794-14.249,0-9.067-3.422-13.925-6.556-13.925-4.742,0-7.917,5.4-9.814,16.3l.907,1.4c1.155-5.4,2.639-8.312,5.031-8.312,2.433,0,4,5.4,4,11.334,0,8.959-2.227,14.141-5.525,15.112Z'
                transform='translate(302.434 123.758)'
              />
              <path
                id='Path_2'
                data-name='Path 2'
                d='M0-175.169H15.443v-2.723c-2.69-.227-3.687-.794-3.687-9.985V-209.89h2.559a8.6,8.6,0,0,0,7.331-3.971c2.472-3.631,4.338-9.645,4.338-18.949,0-7.716-1.171-12.935-3.687-16.906-2.212-3.517-5.856-3.744-9.63-3.744H0v2.723c2.69.227,3.687.794,3.687,9.985v52.876c0,9.191-1,9.758-3.687,9.985Zm11.756-68.647c0-4.085.434-5.106,2-5.106,3.73,0,4.164,8.624,4.164,16.68,0,11.46-.954,17.814-5.422,17.814h-.737Zm15.029,68.647H53.159l1.692-23.714-1.041-.681A62.7,62.7,0,0,1,51.6-188.786c-2.906,8.964-5.119,9.078-9.586,9.078-3.3,0-3.47-1.475-3.47-9.758v-24.849c4.772,0,6.377,5.787,6.941,17.36h1.041v-38.692H45.481c-.564,11.574-2.169,17.361-6.941,17.361v-24.736c0-5.673.564-5.9,2.69-5.9h2.776c5.292,0,7.331,6.014,7.808,17.587h1.041v-22.126H26.785v2.723c2.69.227,3.687.794,3.687,9.985v52.876c0,9.191-1,9.758-3.687,9.985Zm29.17,0H71.4v-2.723c-2.689-.227-3.687-.794-3.687-9.985v-24.055h1.3l8.329,36.763H87.4v-2.723c-.607,0-1.041-.34-1.735-2.383s-1.605-5.673-3.253-12.368l-5.249-21.445c3.427-2.5,6.9-9.191,6.9-19.4,0-10.1-2.906-16.453-6.42-18.609-2.039-1.248-7.027-1.361-11.842-1.361H55.955v2.723c2.689.227,3.687.794,3.687,9.985v52.876c0,9.191-1,9.758-3.687,9.985ZM67.71-243.363c0-4.2.174-6.127,2.386-6.127,3.687,0,5.552,7.148,5.552,16.566,0,12.368-3.08,17.02-7.027,17.02H67.71Zm19.411,68.194h16.571v-2.723c-3.6-.227-4.815-1.929-4.815-9.872v-26.551c4.772,0,6.377,5.787,6.941,17.36h1.041v-38.692h-1.041c-.564,11.574-2.169,17.361-6.941,17.361v-25.3c0-3.971.347-5.333,1.735-5.333H102.3c5.552,0,8.112,3.517,9.2,17.587h1.041l-.347-22.126H87.121v2.723c2.689.227,3.687.794,3.687,9.985v52.876c0,9.191-1,9.758-3.687,9.985Zm34.463-38.125c0-12.481.087-38.238,6.984-38.238s6.984,25.757,6.984,38.238c0,12.935-.087,36.2-6.984,36.2s-6.984-23.261-6.984-36.2m-8.719-1.021c0,23.487,6.463,41.188,15.7,41.188s15.7-17.7,15.7-41.188-6.464-41.188-15.7-41.188-15.7,17.7-15.7,41.188m32.987,39.146h15.443v-2.723c-2.69-.227-3.687-.794-3.687-9.985v-24.055h1.3l8.329,36.763H177.3v-2.723c-.607,0-1.041-.34-1.735-2.383s-1.6-5.673-3.253-12.368l-5.249-21.445c3.427-2.5,6.9-9.191,6.9-19.4,0-10.1-2.906-16.453-6.42-18.609-2.039-1.248-7.027-1.361-11.842-1.361h-9.847v2.723c2.69.227,3.687.794,3.687,9.985v52.876c0,9.191-1,9.758-3.687,9.985Zm11.756-68.194c0-4.2.173-6.127,2.386-6.127,3.687,0,5.552,7.148,5.552,16.566,0,12.368-3.08,17.02-7.027,17.02h-.911Zm19.324,68.194h9.5v-2.723c-3.73,0-4.078-3.971-4.078-12.708v-53.1h.087l10.107,68.534h1.431L204.737-243.7h.087v55.825c0,9.191-1,9.758-3.687,9.985v2.723h15.009v-2.723c-2.69-.227-3.687-.794-3.687-9.985v-52.876c0-9.191,1-9.758,3.687-9.985v-2.723H204.173L196.365-203.2l-7.374-50.266H176.931v2.723c2.169.227,3.34.908,3.34,8.737v49.585c0,13.276-1.215,14.524-3.34,14.524Zm38.93,0H226.1v-2.723c-1.822,0-3.9-.681-3.9-6.695a100.554,100.554,0,0,1,1.6-13.049h10.888l.564,3.291c.391,2.156,1.735,9.3,1.735,11.914,0,2.042-.521,3.517-1.085,3.971a3.693,3.693,0,0,1-2.386.568v2.723H250v-2.723c-1.6,0-2.776-2.269-3.6-5.787s-1.562-7.943-2.646-13.843l-10.807-56.168h-1.475l-10.839,62.523c-1.345,7.829-1.648,12.254-4.771,13.276Zm8.719-27.005L229-228.612l4.728,26.438Z'
                transform='translate(0 255.504)'
              />
            </svg>
          </Link>
        </div>
        <div>{new Date().toLocaleDateString('en-us').replace(/\//g, '.')}</div>
        {width > 300 && <div>{nyTime}</div>}
        {width > 300 && (
          <div>
            {loading ? (
              <Loader></Loader>
            ) : (
              <span className='header-weather'>
                {convertToFahrenheit(weatherData.main.temp)}&deg;
              </span>
            )}
          </div>
        )}
        <div className='hamburger-container'>
          <button
            id='navIcon'
            className={`${isOpen ? 'open' : ''}`}
            onClick={toggleMenu}
            aria-label={`${isOpen ? 'Close Menu' : 'Open Menu'}`}
            name='Menu'
          >
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </button>
        </div>
      </div>
      {location.pathname === '/broadcast/' ? (
        <div></div>
      ) : (
        <Ticker text={`Tickets Available Now!`} header></Ticker>
      )}
      <div className={`secondary-menu ${isOpen ? 'secondary-show' : ''}`}>
        <Link to='/#calendar' onClick={() => setIsOpen(false)}>
          Calendar
        </Link>
        <Link to='/artists' onClick={() => setIsOpen(false)}>
          2023 Artists
        </Link>
        {location?.pathname === '/' ? (
          <button
            className='header-button'
            onClick={() => {
              handleCategoryFilter(['Performa Commission'])
              navigate('/#calendar')
              setIsOpen(false)
            }}
          >
            Performa Commissions
          </button>
        ) : (
          <Link to='/#calendar' state={{ category: ['Performa Commission'] }}>
            Performa Commissions
          </Link>
        )}
        <a
          href='https://www.tickettailor.com/events/performa'
          target='_blank'
          rel='noreferrer'
          onClick={() => setIsOpen(false)}
        >
          Tickets
        </a>
        <Link to='/the-hub' onClick={() => setIsOpen(false)}>
          The Hub
        </Link>
        <Link to='/protest-and-performance' onClick={() => setIsOpen(false)}>
          Protest & Performance
        </Link>
        <Link to='/pavilions' onClick={() => setIsOpen(false)}>
          Finnish Pavilion
        </Link>
        <Link to='/supporters' onClick={() => setIsOpen(false)}>
          Biennial Supporters
        </Link>
        <Link
          to='/performa-2023-opening-night-gala'
          onClick={() => setIsOpen(false)}
        >
          Opening Night Gala
        </Link>
        <Link to='/press' onClick={() => setIsOpen(false)}>
          Press
        </Link>
        <Link to='/about' onClick={() => setIsOpen(false)}>
          About Performa
        </Link>
        <Link to='/broadcast' onClick={() => setIsOpen(false)}>
          Broadcast
        </Link>
      </div>
    </div>
  )
}

export default Header
